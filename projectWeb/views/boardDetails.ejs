<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Board Details</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="icon" type="image/x-icon" href="/pic/apple-touch-icon.png" />
    <link rel="stylesheet" href="/css/styleDetail.css" />
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"
        integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js"
        integrity="sha384-0pUGZvbkm6XF6gxjEnlmuGrJXVbNuzT9qBBavbLwCsOGabYfZo0T0to5eqruptLy"
        crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
    <script
        src="https://cdnjs.cloudflare.com/ajax/libs/moment-timezone/0.5.34/moment-timezone-with-data.min.js"></script>
</head>

<body>
    <div class="container mt-4">
        <h1>Board Details</h1>
        <div class="backTo">
            <a href="/" class="btn btn-primary">Back to Dash Board</a>
        </div>
        <div class="card">
            <div class="card-body">
                <div class="container p-4 bg-white shadow-sm rounded-4 mb-4">
                    <div class="row align-items-center mb-4">
                        <div class="col-md-8">
                            <h2 class="display-4 text-primary fw-bold mb-0">
                                <%= board.nameboard %>
                            </h2>
                        </div>
                        <div class="col-md-4 text-md-end">
                            <button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#changeNameModal">
                                <i class="bi bi-pencil-square"></i> เปลี่ยนชื่อตู้ปลา
                            </button>
                        </div>
                    </div>
                    
                    <div class="bg-light p-3 rounded-3 mb-4">
                        <p class="card-text mb-2">
                            <span class="fw-bold">รหัสตู้ปลา:</span> 
                            <span id="tokenText" class="text-muted"><%= board.token %></span>
                        </p>
                        <button id="copyButton" type="button" class="btn btn-sm btn-secondary" onclick="copyToClipboard()">
                            <i class="bi bi-clipboard"></i> คัดลอกรหัส
                        </button>
                    </div>

                    <div class="row mb-4">
                        <div class="col-md-6">
                            <h3 class="text-primary fw-bold mb-2">อุณหภูมิที่ตั้งไว้</h3>
                            <h2 class="display-4 text-dark fw-bold">
                                <span id="currentTemperature"><%= board.new_temp %></span> °C
                            </h2>
                        </div>
                        <div class="col-md-6">
                            <h3 class="text-primary fw-bold mb-2">อุณหภูมิปัจจุบัน</h3>
                            <h2 id="temp-display-<%= board.token %>" class="display-4 text-dark fw-bold">
                                <%= board.temp %> °C
                            </h2>
                        </div>
                    </div>

                    <div class="row text-center mb-4">
                        <div class="col-4">
                            <i class="fas fa-temperature-low fs-1 text-primary mb-2"></i>
                            <p class="fs-5">อุณหภูมิต่ำสุด: <span id="min-temp" class="text-danger fw-bold">กำลังโหลด...</span> °C</p>
                        </div>
                        <div class="col-4">
                            <i class="fas fa-temperature-high fs-1 text-danger mb-2"></i>
                            <p class="fs-5">อุณหภูมิสูงสุด: <span id="max-temp" class="text-success fw-bold">กำลังโหลด...</span> °C</p>
                        </div>
                        <div class="col-4">
                            <i class="fas fa-droplet fs-1 mb-2" style="color: #BA68C8;"></i>
                            <p class="fs-5">ค่า pH: <span id="ph-level" class="fw-bold"><%= board.ph %></span></p>
                        </div>
                    </div>

                    <div class="text-center">
                        <button type="button" class="btn btn-primary btn-lg" data-bs-toggle="modal" data-bs-target="#changeSettingModal">
                            <i class="bi bi-gear-fill"></i> ปรับการตั้งค่าตู้ปลา
                        </button>
                    </div>
                </div>

                <!-- Modal for Changing Name -->
                <div class="modal fade" id="changeNameModal" tabindex="-1" aria-labelledby="changeNameModalLabel" aria-hidden="true">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header bg-primary text-white">
                                <h5 class="modal-title" id="changeNameModalLabel">เปลี่ยนชื่อตู้ปลา</h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <form id="changeNameForm" action="/updateName" method="POST">
                                    <input type="hidden" name="token" value="<%= board.token %>">
                                    <div class="mb-3">
                                        <label for="name" class="form-label">ชื่อใหม่ของตู้ปลา:</label>
                                        <input type="text" id="name" name="name" class="form-control" placeholder="<%= board.nameboard %>" required>
                                    </div>
                                    <button type="button" id="changeNameButton" class="btn btn-primary w-100">บันทึกชื่อตู้ปลาใหม่</button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Modal for Changing Settings -->
                <div class="modal fade" id="changeSettingModal" tabindex="-1" aria-labelledby="changeSettingModalLabel" aria-hidden="true">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header bg-primary text-white">
                                <h5 class="modal-title" id="changeSettingModalLabel">ปรับการตั้งค่าอุณหภูมิตู้ปลา</h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <form id="changeSettingForm">
                                    <input type="hidden" name="token" value="<%= board.token %>">
                                    <div class="mb-3">
                                        <label for="temp" class="form-label">อุณหภูมิตู้ปลา (°C)</label>
                                        <input type="number" id="temp" name="temp" class="form-control" value="<%= board.new_temp %>" required>
                                    </div>
                                    <button type="submit" class="btn btn-primary w-100">บันทึกการเปลี่ยนแปลงอุณหภูมิตู้ปลา</button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Date Picker -->
                <div class="container mt-5">
                    <h2 class="mb-3">เลือกวันที่ดูข้อมูลตู้ปลา</h2>
                    <div class="input-group mb-3">
                        <input type="date" id="date-picker" class="form-control">
                        <button class="btn btn-primary" id="fetchDataBtn">ดูข้อมูลตู้ปลา</button>
                    </div>
                </div>

                <!-- Graph Area -->
                <div class="container mt-5">
                    <h2 class="mb-3">ข้อมูลอุณหภูมิตู้ปลา</h2>
                    <p class="text-muted" data-date>วันที่ของข้อมูลชุดนี้</p>
                    <canvas id="temperatureChart" width="100%" height="50"></canvas>
                </div>

                <!-- Add pH Chart -->
                <div class="container mt-5">
                    <h2 class="mb-3">ข้อมูล pH ในตู้ปลา</h2>
                    <p class="text-muted" data-date>วันที่ของข้อมูลชุดนี้</p>
                    <canvas id="pHChart" width="100%" height="50"></canvas>
                </div>

                <div class="container mt-5">
                    <h2 class="mb-3">ตารางข้อมูลตู้ปลา</h2>
                    <p class="text-muted" data-date>วันที่ของข้อมูลชุดนี้</p>
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th>วันที่</th>
                                    <th>เวลา</th>
                                    <th>อุณหภูมิตู้ปลา (°C)</th>
                                    <th>pH ในตู้ปลา</th>
                                </tr>
                            </thead>
                            <tbody id="data-table-body">
                                <!-- ข้อมูลจะถูกเพิ่มที่นี่ -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script>
        document.getElementById('changeSettingForm').addEventListener('submit', function (event) {
            event.preventDefault();

            const formData = new FormData(this);
            const token = formData.get('token');
            const temp = formData.get('temp');

            fetch('/updateTemp', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ token, temp })
            })
                .then(response => {
                    if (response.ok) {
                        alert('Temperature update request sent successfully!');
                        // อัพเดตค่าที่แสดงในหน้าเว็บ
                        document.getElementById('currentTemperature').textContent = temp;
                        const modal = bootstrap.Modal.getInstance(document.getElementById('changeSettingModal'));
                        modal.hide();  // ซ่อน modal หลังจากส่งคำขอสำเร็จ
                    } else {
                        alert('Failed to send update request');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Failed to send update request');
                });
        });
    </script>

    <script>
        document.getElementById('changeNameButton').addEventListener('click', () => {
            const formData = new FormData(document.getElementById('changeNameForm'));

            fetch(document.getElementById('changeNameForm').action, {
                method: 'POST',
                body: new URLSearchParams(formData),
            })
                .then(response => response.text())
                .then(result => {
                    alert(result);
                    // อัพเดตชื่อในหน้าเว็บ
                    document.getElementById('currentName').textContent = formData.get('name');
                    // ล้างฟอร์ม
                    document.getElementById('changeNameForm').reset();
                    // ปิดโมดัล
                    bootstrap.Modal.getInstance(document.getElementById('changeNameModal')).hide();
                })
                .catch(error => {
                    console.error('Error:', error);
                });
        });
    </script>

    <script>
        function copyToClipboard() {
            // คัดลอกข้อความจาก span ที่มี id เป็น tokenText
            const tokenText = document.getElementById('tokenText').innerText;
            const tempInput = document.createElement('input');
            tempInput.value = tokenText;
            document.body.appendChild(tempInput);
            tempInput.select();
            document.execCommand('copy');
            document.body.removeChild(tempInput);

            // แจ้งเตือนเมื่อคัดลอกสำเร็จ
            alert('Token copied to clipboard: ' + tokenText);
        }
    </script>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const token = '<%= board.token %>'; // ใช้ token ของบอร์ด
            const yesterday = moment().subtract(1, 'days').format('YYYY-MM-DD'); // วันที่ของวันก่อนหน้า

            // กำหนด timestamp ปัจจุบันในเขตเวลาที่ต้องการ (เช่น Asia/Bangkok)
            const currentTimestamp = moment().tz('Asia/Bangkok').format('YYYY-MM-DD HH:mm:ss');
            console.log('Current Timestamp:', currentTimestamp);

            // ตั้งค่าเริ่มต้นใน date-picker เป็นวันก่อนหน้า
            document.getElementById('date-picker').value = yesterday;

            // ฟังก์ชันสำหรับการดึงข้อมูล
            let tempChart, phChart;
            function fetchDataForDate(selectedDate) {
                fetch(`/getHourlyData?token=${token}&date=${selectedDate}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.length === 0) {
                            console.log('No data available');
                            return;
                        }

                        const labels = [];
                        const tempData = [];
                        const pHData = [];
                        const tableBody = document.getElementById('data-table-body');
                        tableBody.innerHTML = ''; // เคลียร์ข้อมูลเก่าก่อน

                        // อัปเดตวันที่ของข้อมูล
                        const firstEntryDate = new Date(data[0].timestamp);
                        const formattedDate = firstEntryDate.toLocaleDateString('th-TH', {
                            year: 'numeric',
                            month: 'long',
                            day: 'numeric'
                        });

                        // อัปเดตข้อความใน element <p> ที่มี attribute data-date
                        document.querySelectorAll('p[data-date]').forEach(el => {
                            el.textContent = `วันที่ของข้อมูลชุดนี้: ${formattedDate}`;
                        });

                        // คำนวณค่าอุณหภูมิต่ำสุดและสูงสุด
                        const tempValues = data.map(entry => entry.temp);
                        const minTemp = Math.min(...tempValues);
                        const maxTemp = Math.max(...tempValues);

                        // อัปเดตใน HTML
                        document.getElementById('min-temp').textContent = minTemp;
                        document.getElementById('max-temp').textContent = maxTemp;

                        // อัปเดตตารางข้อมูลและกราฟ
                        data.forEach(entry => {
                            // แปลง timestamp จาก UTC เป็นเวลาท้องถิ่น Asia/Bangkok โดยใช้ moment.js
                            const date = moment.utc(entry.timestamp).tz('Asia/Bangkok');

                            labels.push(date.format('HH:mm:ss')); // ใช้ moment เพื่อฟอร์แมตเวลาที่ถูกต้อง
                            tempData.push(entry.temp);
                            pHData.push(entry.ph);

                            // แปลงปี ค.ศ. เป็น พ.ศ.
                            const buddhistYear = date.year() + 543;

                            // ฟอร์แมตวันที่ให้เป็น พ.ศ.
                            const formattedDate = date.format(`DD/MM/${buddhistYear}`);

                            const newRow = document.createElement('tr');
                            newRow.innerHTML = `
        <td>${formattedDate}</td> <!-- วันที่ -->
        <td>${date.format('HH:mm:ss')}</td>    <!-- เวลา -->
        <td>${entry.temp}</td>
        <td>${entry.ph}</td>
    `;
                            tableBody.appendChild(newRow);
                        });

                        // อัปเดตกราฟถ้ายังไม่มีกราฟให้สร้างใหม่แต่ถ้ามีกราฟให้อัพเดต
                        if (!tempChart) {
                            const ctxTemp = document.getElementById('temperatureChart').getContext('2d');
                            tempChart = new Chart(ctxTemp, {
                                type: 'line',
                                data: {
                                    labels: labels,
                                    datasets: [{
                                        label: 'Temperature (°C)',
                                        data: tempData,
                                        borderColor: 'rgba(255, 99, 132, 1)',
                                        fill: false
                                    }]
                                },
                                options: {
                                    scales: {
                                        y: {
                                            beginAtZero: true
                                        }
                                    }
                                }
                            });
                        } else {
                            tempChart.data.labels = labels;
                            tempChart.data.datasets[0].data = tempData;
                            tempChart.update();
                        }

                        if (!phChart) {
                            const ctxPH = document.getElementById('pHChart').getContext('2d');
                            phChart = new Chart(ctxPH, {
                                type: 'line',
                                data: {
                                    labels: labels,
                                    datasets: [{
                                        label: 'pH',
                                        data: pHData,
                                        borderColor: 'rgba(54, 162, 235, 1)',
                                        fill: false
                                    }]
                                },
                                options: {
                                    scales: {
                                        y: {
                                            beginAtZero: true
                                        }
                                    }
                                }
                            });
                        } else {
                            phChart.data.labels = labels;
                            phChart.data.datasets[0].data = pHData;
                            phChart.update();
                        }
                    });
            }
            // เรียกข้อมูลของวันก่อนหน้าเมื่อตอนโหลดหน้าเว็บ
            fetchDataForDate(yesterday);

            // กดปุ่มเพื่อเลือกวันที่ใหม่
            document.getElementById('fetchDataBtn').addEventListener('click', function () {
                const selectedDate = document.getElementById('date-picker').value;
                fetchDataForDate(selectedDate);
            });
        });

    </script>
</body>

</html>